<!DOCTYPE html>
<html lang="en" xml:lang="en" xmlns= "http://www.w3.org/1999/xhtml">
<head>
    <title>Hakwagstam AR</title>

    <meta charset="utf-8">
    <meta name="google" content="notranslate">  
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <!-- Alpine Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/@alpinejs/persist@3.x.x/dist/cdn.min.js"></script>
    <script src="https://unpkg.com/alpinejs-component@latest/dist/component.min.js"></script>
    <!-- Alpine Core -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- AR.js -->
    <script type='text/javascript' src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/three.js/build/ar-threex-location-only.js'></script>
    <script type='text/javascript' src='https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js'></script>
    <script type='text/javascript' src="https://unpkg.com/aframe-text-geometry-component@0.5.2/dist/aframe-text-geometry-component.min.js"></script>
    <script type='text/javascript' src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.2.0/dist/aframe-extras.min.js"></script>
    <script type='text/javascript' src="https://unpkg.com/aframe-look-at-component@1.0.0/dist/aframe-look-at-component.min.js"></script>

    <style>
        #AR-toggle {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5em;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }
    </style>
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.store('global', {
                arModeActive: false,
                points: Alpine.$persist(0).as('hakwadagstamAR-points'),
                activeLocations: [],
                visitedLocations: Alpine.$persist([]).as('hakwadagstamAR-visitedLocations'),
                activeQuestion: 0,
                activeLocation: 0,
     
                toggleArMode() {
                    this.arModeActive = ! this.arModeActive
                },

                setActiveLocationSet(id) {
                    this.activeLocations = this.allLocations.filter((location) => 
                        location.locationSet === id 
                        && !this.visitedLocations.includes(location.id)
                    );
                },

                getLocationUrl(id){
                    loc=this.allLocations.filter((location)=>location.id===id)[0];
                    return "https://www.google.com/maps/dir/?api=1&destination="+loc.latitude+","+loc.longitude;
                },

                allLocations: [
                    {
                        id: 1,
                        locationSet: 1,
                        latitude: 52.50770893871821,
                        longitude: 6.097938843248748,
                        html: "<a-entity greenbox material='color: green' geometry='primitive: box' gps-new-entity-place='latitude: 52.50770893871821; longitude: 6.097938843248748' scale='10 10 10'></a-entity>"
                    },
                    {
                        id:2,
                        locationSet:1,
                        latitude: 52.3733762,
                        longitude: 6.4591569,
                        html: ""
                    }
                ],

                allQuestions:[
                    {
                        id: 1,
                        text: "Wat is 1+1?",
                        answers: [
                            {text: "1", correct: false, locationId: 1}, 
                            {text: "2", correct: true, locationId: 2},
                            {text: "3", correct: false, locationId: 3}
                        ]
                    },
                    {
                        id:2,
                        text: "Geef het goede antwoord",
                        answers: [
                            {text: "Dit is goed", correct: true, locationId: 4}, 
                            {text: "Deze is fout", correct: false, locationId: 5},
                            {text: "Deze ook", correct: false, locationId: 6}
                        ]
                    }
                ]
            });

            Alpine.store('global').setActiveLocationSet(1);
        })

        function enterArMode() {
            // Everytime AR.js loads it adds a <video> element to the root of the <body> element
            // We don't need it and it block input so we remove it
            document.querySelectorAll('body > video').forEach(e => e.remove());

            // TODO: Here we should decide which locations we want to show
            Alpine.store('global').activeLocations.forEach( (location) => {
                var newElement = document.createElement('div');
                newElement.innerHTML = location.html;
                document.querySelector('a-scene').appendChild(newElement.firstChild);
            })
        }
    </script>
</head>
<body style="background-color: green;">
    <div x-data>
        <button id="AR-toggle" @click="$store.global.toggleArMode()" x-text="$store.global.arModeActive ? 'Exit AR' : 'Enter AR'">Toggle AR</button>
     
        <template x-if="$store.global.arModeActive">
            <div x-init="$nextTick(() => { enterArMode(); })">
                <script>
                    AFRAME.registerComponent('greenbox', {
                        init: function() {
                            this.el.addEventListener('click', e => {
                                console.log(e);
                                alert('Green box clicked!');
                            });
                        }
                    });
                </script>
                <a-scene
                    vr-mode-ui='enabled: false'
                    arjs='sourceType: webcam; videoTexture: true; debugUIEnabled: false'
                    renderer='antialias: true; alpha: true;'
                    cursor='rayOrigin: mouse; fuseTimeout: 0;'
                    raycaster='near: 0; far: 50000'
                    >
                    <a-camera id='camera'
                        gps-new-camera='gpsMinDistance: 5;'
                        look-controls-enabled='false'
                        arjs-device-orientation-controls='smoothingFactor: 0.1'
                        >
                    </a-camera>
                    <!-- gps-new-camera='gpsMinDistance: 5; simulateLatitude: 52.50756129569016; simulateLongitude:6.09750736459537;' -->
                
                    <!-- <template x-for="location in $store.global.activeLocations">
                        <a-entity x-html="location.html"></a-entity>
                    </template> -->

                    <!-- Park voor mijn huis -->
                    <!-- <a-entity id='greenbox' material='color: green' geometry='primitive: box' gps-new-entity-place='latitude: 52.50770893871821; longitude: 6.097938843248748' scale='10 10 10'></a-entity> -->
                
                </a-scene>
            </div>
        </template>

        <div x-show="!$store.global.arModeActive" class="container">
            <h1>Hakwadagstam AR app</h1>
            <h3>Kies de vraag die je wil beantwoorden</h3>
            
            <!--List with all questions-->
            <div class="row" x-show="$store.global.activeQuestion===0">
                <template x-for="(question) in $store.global.allQuestions" :key="question.id">
                    <div class="col">
                        <div class="card">
                            <div class="card-body" @click="$store.global.activeQuestion=question.id" x-text="question.id"></div>
                        </div> 
                    </div>
                </template>
            </div>

            <!--Show active question-->
            <template x-if="$store.global.activeQuestion!==0">
                <div>
                    <p x-text="$store.global.allQuestions.find((question)=>question.id==$store.global.activeQuestion).text"></p>
                    <div class="row">
                        <template x-for="answer in $store.global.allQuestions.find((question)=>question.id==$store.global.activeQuestion).answers" >
                            <div class="col">
                                <button class="btn btn-light btn-lg" @click="$store.global.activeLocation=answer.locationId" x-text="answer.text">
                                </button>
                            </div>
                        </template>
                    </div>
                    <div class="row">
                        <p>Ga naar de volgende locatie en activeer daar de AR</p>
                        <a class="btn btn-info" x-show="$store.global.activeLocation!==0" x-bind:href="$store.global.getLocationUrl($store.global.activeLocation)">Klik hier om naar de locatie te navigeren</a>
                    </div>
                    <div class="row">
                        <button class="btn btn-warning" @click="$store.global.activeQuestion=0">Terug naar vragen overzicht</button>
                    </div>
                </div>
            </template>
        </div> 
    </div>

    <template id="entity-box">
        <a-entity 
        geometry="primitive: box" material="color: red"></a-entity>
    </template>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>